#!/bin/bash
#
# SPDX-FileCopyrightText: 2014 David Goulet <dgoulet@efficios.com>
#
# SPDX-License-Identifier: LGPL-2.1-only

TEST_DESC="Load session(s)"

CURDIR=$(dirname "$0")/
CONFIGDIR="${CURDIR}/configuration"
TESTDIR=$CURDIR/../../../

SESSION_NAME="load-42"

NUM_TESTS=104

# shellcheck source-path=SCRIPTDIR/../../..
source "$TESTDIR/utils/utils.sh"

# MUST set TESTDIR before calling those functions
plan_tests $NUM_TESTS

print_test_banner "$TEST_DESC"

function get_channel_allocation_policy()
{
    local mi_path=$1
    local channel_name=$2
    "$XML_EXTRACT" "$mi_path" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain/lttng:channels/lttng:channel[lttng:name='$channel_name']/lttng:attributes/lttng:allocation_policy/text()"
}

function get_session_trace_format()
{
    local mi_path=$1
    "$XML_EXTRACT" "$mi_path" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:trace_format/text()"
}

function test_basic_load()
{
	diag "Test basic load"

	lttng_load_ok -i "$CURDIR/$SESSION_NAME.lttng"

	destroy_lttng_session_ok $SESSION_NAME
}

function test_complex_load()
{
	local sess_name="$SESSION_NAME-complex"
	local ret
	local mi_result
	local mi_output_file

	diag "Test complex load"

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	# Start relayd with localhost binding. The complex session uses those
	# custom values.
	start_lttng_relayd -C tcp://localhost:8172 -D tcp://localhost:9817

	lttng_load_ok -i "$CURDIR/$sess_name.lttng"

	# Once loaded, we are suppose to be able to disable certain events/channels
	# thus having a confirmation that it's valid
	disable_ust_lttng_event "$sess_name" uevent1 chan1
	disable_ust_lttng_event "$sess_name" uevent2 chan2
	disable_ust_lttng_event "$sess_name" 'uevent3*' chan3

	disable_ust_lttng_channel "$sess_name" chan1
	disable_ust_lttng_channel "$sess_name" chan2
	disable_ust_lttng_channel "$sess_name" chan3

	# Confirm that an event stored as disabled is restored in its disabled state
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$sess_name" -c chan2
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain[lttng:type='UST']/lttng:channels/lttng:channel[lttng:name='chan2']/lttng:events/lttng:event[lttng:name='uevent_disabled']/lttng:enabled/text()")
	is "$mi_result" "false" "Disabled event is loaded in disabled state"

	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain/lttng:channels/lttng:channel[lttng:name='chan2']/lttng:events/lttng:event[lttng:name='uevent_disabled']/lttng:enabled/text()")
	is "$mi_result" "false" "Disabled event is loaded in disabled state"

	# Check that uevent_same_name_diff_llevel with log level 6 (TRACE_INFO) is enabled
	# This ensure that the state of events with similar name but not same
	# descriptor tuple (exclusion,filter,loglevel) is restored correctly.
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain/lttng:channels/lttng:channel[lttng:name='chan2']/lttng:events/lttng:event[lttng:name='uevent_same_name_diff_llevel' and lttng:loglevel='TRACE_INFO']/lttng:enabled/text()")
	is "$mi_result" "true" "Enabled event with same name but different loglevel is in disabled state"

	# Redo the listing to get all channels.
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$sess_name"
	mi_result=$(get_channel_allocation_policy "$mi_output_file" "chan1")
	is "$mi_result" "PER_CPU" "Loading default channel allocation policy expecting PER_CPU"

	mi_result=$(get_channel_allocation_policy "$mi_output_file" "chan2")
	is "$mi_result" "PER_CPU" "Loading channel allocation policy PER_CPU"

	mi_result=$(get_channel_allocation_policy "$mi_output_file" "chan3")
	is "$mi_result" "PER_CHANNEL" "Loading channel allocation policy PER_CHANNEL"

	destroy_lttng_session_ok "$sess_name"

	stop_lttng_relayd

	rm -f "$mi_output_file"
}

function test_all_load()
{
	diag "Test load all sessions"

	# Start relayd with localhost binding. The complex session uses those
	# custom values.
	start_lttng_relayd -C tcp://localhost:8172 -D tcp://localhost:9817

	lttng_load_ok -a -i "$CURDIR"

	destroy_lttng_session_ok $SESSION_NAME
	destroy_lttng_session_ok "$SESSION_NAME-complex"
	destroy_lttng_session_ok "$SESSION_NAME-ctf-1.8"
	destroy_lttng_session_ok "$SESSION_NAME-no-trace-format"
	destroy_lttng_session_ok "$SESSION_NAME-trackers"
	destroy_lttng_session_ok "tracker_legacy_all"
	destroy_lttng_session_ok "tracker_legacy_none"
	destroy_lttng_session_ok "tracker_legacy_selective"

	stop_lttng_relayd
}

function test_overwrite()
{
	diag "Test load overwrite"

	lttng_load_ok -i "$CURDIR/$SESSION_NAME.lttng"

	# This one should succeed
	lttng_load_ok -f -i "$CURDIR" "$SESSION_NAME"

	destroy_lttng_session_ok $SESSION_NAME
}

function test_trackers()
{
	local mi_output_file

	diag "Test trackers loading"

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	lttng_load_ok -i "$CURDIR/$SESSION_NAME-trackers.lttng"

	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$SESSION_NAME-trackers"
	mi_result=$($XML_NODE_CHECK "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain/lttng:process_attr_trackers/lttng:vpid_process_attr_tracker/lttng:process_attr_values/lttng:vpid")
	is "$mi_result" "true" "VPID target is present"

	mi_result=$($XML_NODE_CHECK "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain/lttng:process_attr_trackers/lttng:vuid_process_attr_tracker/lttng:process_attr_values/lttng:vuid")
	is "$mi_result" "true" "VUID target is present"

	mi_result=$($XML_NODE_CHECK "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:domains/lttng:domain/lttng:process_attr_trackers/lttng:vgid_process_attr_tracker/lttng:process_attr_values/lttng:vgid")
	is "$mi_result" "true" "VGID target is present"

	# Test to remove the target just to make sure
	lttng_untrack_ok --vpid 666 -u -s "$SESSION_NAME-trackers"
	lttng_untrack_ok --vuid 777 -u -s "$SESSION_NAME-trackers"
	lttng_untrack_ok --vgid 888 -u -s "$SESSION_NAME-trackers"
	# Actually using vpid (backward compat)
	lttng_untrack_ok --pid 999 -u -s "$SESSION_NAME-trackers"

	destroy_lttng_session_ok "$SESSION_NAME-trackers"

	rm -f "$mi_output_file"
}

function test_override_url_normal()
{
	local local_url_override="file:///tmp/override/to/here"
	local local_path_override="/tmp/override/to/here"
	local local_path_compare_value="/tmp/override/to/here"
	local stream_url_override="net://127.0.0.1:8172:9817"
	local stream_url_compare="tcp4://127.0.0.1:8172/ [data: 9817]"
	local mi_output_file

	diag "Test url override for normal session"

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	start_lttng_relayd -C tcp://127.0.0.1:8172 -D tcp://127.0.0.1:9817

	# Url of style file://
	lttng_load_ok -i "$CURDIR/$SESSION_NAME.lttng" --override-url="${local_url_override}"

	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$SESSION_NAME"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:path")

	is "$mi_result" "${local_path_compare_value}" "Path url file:// override [{$mi_result}, ${local_path_compare_value}]"

	destroy_lttng_session_ok "$SESSION_NAME"

	# Url of style /
	lttng_load_ok -i "$CURDIR/$SESSION_NAME.lttng" "--override-url=${local_path_override}"

	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$SESSION_NAME"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:path")

	is "$mi_result" "${local_path_compare_value}" "Path url / override [{$mi_result}, ${local_path_compare_value}]"
	destroy_lttng_session_ok "$SESSION_NAME"

	# Url of style net://ip:port:port
	lttng_load_ok -i "$CURDIR/$SESSION_NAME.lttng" --override-url="${stream_url_override}"
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$SESSION_NAME"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:path")

	test "$mi_result" = "${stream_url_compare}"
	ok $? "Path url net://host:port:port override [${mi_result}, ${stream_url_compare}]"

	destroy_lttng_session_ok "$SESSION_NAME"
	stop_lttng_relayd

	rm -f "${mi_output_file}"
}

function test_override_url_snapshot()
{
	local url_override="file:///tmp/override/to/here"
	local path_override="/tmp/override/to/here"
	local path_compare_value="/tmp/override/to/here"
	local stream_url_override="net://127.0.0.1:8172:9817"
	local stream_url_compare_ctrl="tcp4://127.0.0.1:8172/"
	local stream_url_compare_data="tcp4://127.0.0.1:9817/"
	local local_session_name="${SESSION_NAME}-snapshot"
	local mi_output_file

	diag "Test url override for snapshot session"

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	start_lttng_relayd -C tcp://127.0.0.1:8172 -D tcp://127.0.0.1:9817

	# Url of style file://
	lttng_load_ok -i "$CONFIGDIR/$local_session_name.lttng" --override-url="${url_override}"
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" lttng_snapshot_list "$local_session_name"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:snapshot_action/lttng:output/lttng:session/lttng:snapshots/lttng:snapshot/lttng:ctrl_url")
	is "$mi_result" "${path_compare_value}" "Path url file:// override [{$mi_result}, ${path_compare_value}]"
	destroy_lttng_session_ok "$local_session_name"

	# Url of style /
	lttng_load_ok -i "$CONFIGDIR/$local_session_name.lttng" --override-url="${path_override}"
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" lttng_snapshot_list "$local_session_name"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:snapshot_action/lttng:output/lttng:session/lttng:snapshots/lttng:snapshot/lttng:ctrl_url")

	is "$mi_result" "${path_compare_value}" "Path url / override [{$mi_result}, ${path_compare_value}]"
	destroy_lttng_session_ok "$local_session_name"

	# Url of style net://ip:port:port
	lttng_load_ok -i "$CONFIGDIR/$local_session_name.lttng" --override-url="${stream_url_override}"
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" lttng_snapshot_list "$local_session_name"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:snapshot_action/lttng:output/lttng:session/lttng:snapshots/lttng:snapshot/lttng:ctrl_url")

	is "$mi_result" "${stream_url_compare_ctrl}" "Path url ctrl net://host:port:port override [${mi_result}, ${stream_url_compare_ctrl}]"

	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:snapshot_action/lttng:output/lttng:session/lttng:snapshots/lttng:snapshot/lttng:data_url")

	is "$mi_result" "${stream_url_compare_data}" "Path url data net://host:port:port override [${mi_result}, ${stream_url_compare_data}]"

	destroy_lttng_session_ok "$local_session_name"
	stop_lttng_relayd

	rm -f "${mi_output_file}"
}

function test_override_url_live()
{
	local url_override="file:///tmp/override/to/here"
	local path_override="/tmp/override/to/here"
	local path_compare_value="/tmp/override/to/here"
	local stream_url_override="net://127.0.0.1:8172:9817"
	local stream_url_compare="tcp4://127.0.0.1:8172/ [data: 9817]"
	local local_session_name="${SESSION_NAME}-live"
	local mi_output_file

	diag "Test url override for live session"

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	start_lttng_relayd -C tcp://127.0.0.1:8172 -D tcp://127.0.0.1:9817

	# Url of style file://
	# Expect this to fail since live session should never accept local
	# output.
	lttng_load_fail -i "$CONFIGDIR/$local_session_name.lttng" --override-url="${url_override}"
	destroy_lttng_session_fail "$local_session_name"

	# Url of style /
	# Expect this to fail since live session should never accept local
	# output.
	lttng_load_fail -i "$CONFIGDIR/$local_session_name.lttng" --override-url="${path_override}"
	destroy_lttng_session_fail "$local_session_name"

	# Url of style net://ip:port:port
	lttng_load_ok -i "$CONFIGDIR/$local_session_name.lttng" --override-url="${stream_url_override}"
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$local_session_name"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:path")

	is "$mi_result" "${stream_url_compare}" "Path url net://host:port:port override [${mi_result}, ${stream_url_compare}]"

	destroy_lttng_session_ok "$local_session_name"
	stop_lttng_relayd

	rm -f "$mi_output_file"
}

function test_override_session_name()
{
	local override_name="PinkyAndTheBrain"
	local output_path="/tmp/lttng/load-42-1"
	local mi_output_file

	diag "Test session name override"

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	lttng_load_ok -i "${CURDIR}/${SESSION_NAME}.lttng" --override-name="${override_name}" "${SESSION_NAME}"
	list_lttng_fail "${SESSION_NAME}"

	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "${override_name}"
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:name")

	is "${mi_result}" "${override_name}" "Override name successful  [${SESSION_NAME} to ${override_name}]"

	# Make sure that the name override did not change something else
	mi_result=$("$XML_EXTRACT" "$mi_output_file" "//lttng:command/lttng:output/lttng:sessions/lttng:session/lttng:path")
	is "${mi_result}" "${output_path}" "Output path is not affected by name override"

	destroy_lttng_session_ok "${override_name}"

	diag "Test session name override with all (Do not permit)"
	lttng_load_fail -i "${CURDIR}/${SESSION_NAME}.lttng" --override-name="${override_name}"

	rm -f "${mi_output_file}"
}

function test_trace_format_one()
{
	local -r session_file=$1
	local -r sess_name=$2
	local -r expected_format=$3
	local -r test_desc=$4
	local mi_output_file

	mi_output_file=$(mktemp -t "tmp.${FUNCNAME[0]}_output_file.XXXXXX")

	lttng_load_ok -i "$session_file"
	LTTNG_TEST_MI_CLIENT=1 OUTPUT_DEST="$mi_output_file" list_lttng_ok "$sess_name"

	local mi_result

	mi_result=$(get_session_trace_format "$mi_output_file")
	is "$mi_result" "$expected_format" "$test_desc"
	destroy_lttng_session_ok "$sess_name"
	rm -f "$mi_output_file"
}

function test_trace_format()
{
	diag "Test trace format loading"

	# Test loading session with CTF 2 trace format
	# (`load-42.lttng` has CTF 2).
	test_trace_format_one \
		"$CURDIR/$SESSION_NAME.lttng" \
		"$SESSION_NAME" \
		CTF_2 \
		"With CTF 2: loads correctly"

	# Test loading session with CTF 1.8 trace format.
	test_trace_format_one \
		"$CURDIR/$SESSION_NAME-ctf-1.8.lttng" \
		"$SESSION_NAME-ctf-1.8" \
		CTF_1_8 \
		"With CTF 1.8: loads correctly"

	# Test loading legacy session without `trace_format` element (should
	# default to CTF 1.8).
	test_trace_format_one \
		"$CURDIR/$SESSION_NAME-no-trace-format.lttng" \
		"$SESSION_NAME-no-trace-format" \
		CTF_1_8 \
		"Without explicit trace format: loads correctly as CTF 1.8"
}

start_lttng_sessiond

test_basic_load
test_complex_load
test_all_load
test_overwrite
test_trackers
test_override_session_name
test_override_url_normal
test_override_url_snapshot
test_override_url_live
test_trace_format

stop_lttng_sessiond
